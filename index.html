<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Salesman - Royal Sherwani</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --gold: #D4AF37; --bg: #050505; --card: #141414; --text: #E0E0E0;
            --shop: #4CAF50; --godown: #FF9800; --transit: #2196F3; --packed: #9C27B0;
            --master: #FF9800; --done: #00E676;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 0; padding-bottom: 80px; }
        h1, h2, h3 { font-family: 'Cinzel', serif; color: var(--gold); margin: 0; }
        .hidden { display: none !important; }
        .full-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; }

        /* HEADER & TABS */
        .header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #111; position: sticky; top: 0; z-index: 50; }
        .tabs { display: flex; gap: 5px; padding: 10px; background: #111; overflow-x: auto; }
        .tab-btn { flex: 1; background: #222; border: 1px solid #444; color: #888; padding: 10px 5px; border-radius: 8px; font-size: 11px; white-space: nowrap; cursor: pointer; text-align: center; }
        .tab-btn.active { background: var(--gold); color: black; font-weight: bold; border-color: var(--gold); }

        /* SEARCH */
        .search-area { padding: 10px; display: flex; gap: 10px; position: sticky; top: 60px; z-index: 40; background: var(--bg); }
        .search-input { flex: 1; background: #222; border: 1px solid #333; color: white; padding: 10px; border-radius: 10px; }
        .icon-btn { width: 45px; background: #333; border: 1px solid var(--gold); color: var(--gold); border-radius: 10px; font-size: 20px; cursor: pointer; }

        /* GRID */
        .design-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .design-card { background: var(--card); border: 1px solid #333; border-radius: 12px; overflow: hidden; position: relative; }
        .card-img { width: 100%; aspect-ratio: 1; object-fit: cover; }
        .qty-badge { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; border: 1px solid #555; }
        .card-body { padding: 8px; text-align: center; }
        .card-title { font-size: 12px; font-weight: bold; color: white; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; justify-content: center; align-items: center; }
        .modal-content { background: var(--card); border-radius: 16px; width: 95%; max-width: 450px; border: 1px solid var(--gold); max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .modal-img-area { position: relative; height: 250px; background: black; }
        .modal-img { width: 100%; height: 100%; object-fit: contain; }
        
        .stock-list { padding: 10px; overflow-y: auto; flex: 1; }
        .stock-item { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 12px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid #555; }
        .stock-item.shop { border-left-color: var(--shop); }
        .stock-item.godown { border-left-color: var(--godown); }
        
        .qr-id { font-family: monospace; color: var(--gold); font-size: 10px; display: block; margin-top: 2px; }

        /* SPLIT VIEW */
        .split-container { display: flex; gap: 10px; padding: 10px; }
        .split-col { flex: 1; background: #111; padding: 10px; border-radius: 8px; border: 1px solid #333; min-height: 200px; }
        .col-title { font-size: 12px; font-weight: bold; color: #888; text-align: center; margin-bottom: 10px; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        .packed-card { background: #222; padding: 8px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #444; font-size: 11px; }
        .packed-bill { color: var(--gold); font-weight: bold; font-size: 12px; }
        .btn-send { background: #333; color: white; border: 1px solid #555; font-size: 9px; padding: 4px 8px; border-radius: 4px; margin-top: 5px; width: 100%; cursor: pointer; }

        /* DIRECT PACK BUTTON */
        .btn-pack-main { background: var(--packed); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; font-size: 12px; margin-right: 10px; cursor: pointer; }

        /* LOGIN */
        .login-box { width: 85%; max-width: 320px; text-align: center; }
        .inp { width: 100%; padding: 15px; background: #222; border: 1px solid #444; color: white; border-radius: 12px; margin-bottom: 15px; }
        .btn-main { width: 100%; padding: 15px; background: linear-gradient(135deg, var(--gold), #AA8C2C); border: none; font-weight: 800; border-radius: 12px; color: black; }

        /* SCANNER */
        #scanner-modal { background: black; }
        #reader { width: 100%; border: 2px solid var(--gold); }
        .loader { border: 3px solid #333; border-top: 3px solid var(--gold); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="login-screen" class="full-screen">
        <h2 style="color:var(--gold); margin-bottom:20px;">SALESMAN</h2>
        <div class="login-box"><input type="email" id="email" class="inp" placeholder="Email"><input type="password" id="password" class="inp" placeholder="Password"><button onclick="handleLogin()" class="btn-main">LOGIN</button><p id="login-msg" style="color:var(--danger); margin-top:10px; font-size:12px;"></p></div>
    </div>

    <div id="dashboard-screen" style="display:none;">
        <div class="header">
            <div>ROYAL SHERWANI</div>
            <div style="display:flex; align-items:center;">
                <button class="btn-pack-main" onclick="startDirectPack()">üì¶ DIRECT PACK</button>
                <button onclick="handleLogout()" style="background:none; border:1px solid #444; color:#888; padding:5px 10px; border-radius:15px; font-size:10px;">LOGOUT</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('inventory')">INVENTORY</button>
            <button class="tab-btn" onclick="switchTab('packed')">PACKED ORDERS</button>
            <button class="tab-btn" onclick="switchTab('master')">MASTER JI</button>
        </div>

        <div id="inventory-view">
            <div class="search-area">
                <input type="text" id="search-input" class="search-input" placeholder="Design Name or Scan Item..." oninput="filterDesigns()">
                <button class="icon-btn" onclick="startSearchScanner()">üì∑</button>
            </div>
            <div id="designs-grid" class="design-grid"></div>
            <div id="main-loader" class="loader"></div>
        </div>

        <div id="packed-view" style="display:none;">
            <div class="split-container">
                <div class="split-col"><div class="col-title" style="color:var(--info)">üõçÔ∏è SHOP PACKED</div><div id="shop-packed-list"></div></div>
                <div class="split-col"><div class="col-title" style="color:var(--packed)">üì¶ GODOWN PACKED</div><div id="godown-packed-list"></div></div>
            </div>
            <div id="packed-loader" class="loader"></div>
        </div>

        <div id="master-view" style="display:none;">
            <div class="split-container">
                <div class="split-col"><div class="col-title" style="color:orange">‚è≥ PENDING / WORKING</div><div id="master-pending-list"></div></div>
                <div class="split-col"><div class="col-title" style="color:var(--done)">‚úÖ DONE</div><div id="master-done-list"></div></div>
            </div>
            <div id="master-loader" class="loader"></div>
        </div>
    </div>

    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <button onclick="closeModal('detail-modal')" style="position:absolute; top:10px; right:10px; z-index:10; background:rgba(0,0,0,0.5); color:white; border:none; width:30px; height:30px; border-radius:50%;">‚úï</button>
            <div class="modal-img-area"><img id="det-img" src="" class="modal-img"></div>
            <div style="padding:15px; border-bottom:1px solid #333;"><h3 id="det-no" style="color:var(--gold)">#0000</h3><span id="det-name" style="color:#ccc; font-size:14px;">Design Name</span></div>
            <div class="stock-list" id="stock-list"></div>
        </div>
    </div>

    <div id="pack-modal" class="modal">
        <div class="modal-content" style="height:auto; padding:20px;">
            <h3>SEND TO PACKING</h3>
            <div style="display:flex; gap:10px; margin-bottom:15px; background:#222; padding:10px; border-radius:8px;">
                <img id="pack-img" src="" style="width:60px; height:60px; object-fit:cover; border-radius:4px;">
                <div>
                    <div id="pack-design" style="font-weight:bold; color:white;">--</div>
                    <div id="pack-id" style="font-family:monospace; color:var(--gold); font-size:12px;">--</div>
                    <div id="pack-size" style="font-size:12px; color:#888;">Size: --</div>
                    <div id="pack-status-row" style="display:none; font-size:10px; color:orange; margin-top:5px; font-weight:bold;">ALREADY LINKED: Bill #<span id="pack-current-bill"></span></div>
                </div>
            </div>
            
            <input type="text" id="pack-bill-input" class="inp" placeholder="Enter Bill Number">
            
            <button onclick="confirmDirectPack()" class="btn-main">CONFIRM & PACK (SHOP)</button>
            <button onclick="closeModal('pack-modal')" style="width:100%; margin-top:10px; background:none; border:none; color:#888;">Cancel</button>
        </div>
    </div>

    <div id="scanner-modal" class="modal"><div style="width:100%; text-align:center;"><div id="reader"></div><button onclick="stopScanner()" style="margin-top:20px; background:#333; color:white; padding:10px 30px; border:none; border-radius:20px;">CLOSE</button></div></div>

    <script>
        const SUPABASE_URL = 'https://wsfpwzfkvuaeqoucphhu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzZnB3emZrdnVhZXFvdWNwaGh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NTQ0MDksImV4cCI6MjA4MDMzMDQwOX0.eK_6NzB-1ULEPOD3tCytur4h59JI5pW9hKy-M5AvSyk';
        let supabase; try { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) { alert("Init Error"); }
        
        let allDesigns=[], allItems=[], currentItemForPack=null, html5QrCode=null;

        window.onload = () => {
            if(!supabase) return;
            supabase.auth.onAuthStateChange((e, s) => {
                if(s){ document.getElementById('login-screen').classList.add('hidden'); document.getElementById('dashboard-screen').style.display='block'; loadInventory(); }
                else { document.getElementById('login-screen').classList.remove('hidden'); document.getElementById('dashboard-screen').style.display='none'; }
            });
        };

        async function handleLogin() {
            document.getElementById('login-msg').innerText = "Logging in...";
            const { error } = await supabase.auth.signInWithPassword({ email:document.getElementById('email').value, password:document.getElementById('password').value });
            if(error) document.getElementById('login-msg').innerText = error.message;
        }
        async function handleLogout() { await supabase.auth.signOut(); location.reload(); }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            ['inventory', 'packed', 'master'].forEach(t => document.getElementById(t+'-view').style.display = 'none');
            document.getElementById(tab+'-view').style.display = 'block';
            if(tab === 'inventory') loadInventory();
            else if(tab === 'packed') loadPackedOrders();
            else if(tab === 'master') loadMasterStatus();
        }

        // --- INVENTORY ---
        async function loadInventory() {
            const loader = document.getElementById('main-loader'); loader.style.display = 'block';
            try {
                const { data: designs, error: err1 } = await supabase.from('designs').select('*').order('created_at', { ascending: false });
                if(err1) throw err1;
                const { data: items, error: err2 } = await supabase.from('items').select('id, design_no, current_location, size').is('bill_number', null).in('current_location', ['GODOWN_STOCK', 'SHOP_FLOOR']);
                if(err2) throw err2;

                allItems = items || [];
                const counts = {};
                allItems.forEach(i => { if(!counts[i.design_no]) counts[i.design_no] = 0; counts[i.design_no]++; });
                allDesigns = (designs || []).map(d => ({ ...d, qty: counts[d.design_no] || 0 }));
                renderGrid(allDesigns);
            } catch(e) { alert(e.message); } finally { loader.style.display = 'none'; }
        }

        function renderGrid(list) {
            const grid = document.getElementById('designs-grid'); grid.innerHTML = '';
            if(!list || list.length === 0) { grid.innerHTML = '<p style="text-align:center; color:#666; grid-column:1/-1;">No Designs Found</p>'; return; }
            list.forEach(d => {
                grid.innerHTML += `<div class="design-card" onclick="openDetail('${d.design_no}', '${d.image_url}', '${d.name}')">
                    <div class="qty-badge">${d.qty} Pcs</div>
                    <img src="${d.image_url}" class="card-img" loading="lazy">
                    <div class="card-body"><div class="card-title">#${d.design_no}</div></div>
                </div>`;
            });
        }

        function filterDesigns() {
            const q = document.getElementById('search-input').value.trim().toLowerCase();
            if(!q) { renderGrid(allDesigns); return; }
            const matches = allDesigns.filter(d => d.design_no.toLowerCase().includes(q) || d.name.toLowerCase().includes(q));
            renderGrid(matches);
        }

        function startSearchScanner() {
            document.getElementById('scanner-modal').style.display='flex';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async (txt) => {
                stopScanner();
                const { data: item } = await supabase.from('items').select('design_no').eq('id', txt).single();
                if(item) {
                    const matches = allDesigns.filter(d => d.design_no === item.design_no);
                    renderGrid(matches);
                    if(matches.length > 0) openDetail(matches[0].design_no, matches[0].image_url, matches[0].name);
                } else alert("Item not found");
            });
        }

        async function openDetail(no, img, name) {
            document.getElementById('det-img').src = img; document.getElementById('det-no').innerText = "#" + no; document.getElementById('det-name').innerText = name;
            document.getElementById('detail-modal').style.display = 'flex';
            const list = document.getElementById('stock-list'); list.innerHTML = '<div class="loader" style="display:block"></div>';
            const filtered = allItems.filter(i => i.design_no === no).sort((a,b) => a.size - b.size);
            list.innerHTML = '';
            if(filtered.length === 0) list.innerHTML = '<p style="text-align:center; color:#666;">Out of Stock</p>';
            filtered.forEach(i => {
                const isShop = i.current_location === 'SHOP_FLOOR';
                list.innerHTML += `<div class="stock-item ${isShop ? 'shop' : 'godown'}"><div><div style="font-weight:bold;color:white">Size: ${i.size}</div><div style="font-size:10px;color:${isShop?'var(--shop)':'var(--godown)'}">${isShop?'IN SHOP':'IN GODOWN'}</div><span class="qr-id">${i.id}</span></div></div>`;
            });
        }

        // --- DIRECT PACK FLOW (UPDATED to SHOP_PACKED) ---
        function startDirectPack() {
            document.getElementById('scanner-modal').style.display='flex';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async (txt) => {
                stopScanner();
                const { data: item } = await supabase.from('items').select('*, designs(name, image_url)').eq('id', txt).single();
                if(!item) return alert("Item Not Found");
                
                currentItemForPack = item;
                document.getElementById('pack-img').src = item.designs?.image_url || '';
                document.getElementById('pack-design').innerText = item.designs?.name || 'Unknown';
                document.getElementById('pack-id').innerText = item.id;
                document.getElementById('pack-size').innerText = "Size: " + item.size;
                
                const billInput = document.getElementById('pack-bill-input');
                const statusRow = document.getElementById('pack-status-row');
                const currentBill = document.getElementById('pack-current-bill');

                if(item.bill_number) {
                    billInput.style.display = 'none';
                    statusRow.style.display = 'block';
                    currentBill.innerText = item.bill_number;
                } else {
                    billInput.style.display = 'block';
                    statusRow.style.display = 'none';
                    billInput.value = '';
                    billInput.focus();
                }
                document.getElementById('pack-modal').style.display = 'flex';
            });
        }

        async function confirmDirectPack() {
            const billInput = document.getElementById('pack-bill-input');
            let finalBill = currentItemForPack.bill_number; 
            if(!finalBill) {
                finalBill = billInput.value.trim();
                if(!finalBill) return alert("Enter Bill No");
            }
            closeModal('pack-modal');
            // UPDATE TO SHOP_PACKED instead of TRANSIT
            const { error } = await supabase.from('items').update({ 
                bill_number: finalBill, 
                current_location: 'SHOP_PACKED' 
            }).eq('id', currentItemForPack.id);
            
            if(error) alert(error.message); 
            else { alert("Packed at Shop!"); loadInventory(); }
        }

        // --- PACKED ORDERS ---
        async function loadPackedOrders() {
            document.getElementById('packed-loader').style.display = 'block';
            const { data: items } = await supabase.from('items').select('*, designs(name)').in('current_location', ['GODOWN_PACKED', 'SHOP_PACKED', 'TRANSIT_TO_PACKING']).order('bill_number', {ascending:false});
            const sList = document.getElementById('shop-packed-list');
            const gList = document.getElementById('godown-packed-list');
            sList.innerHTML = ''; gList.innerHTML = '';
            document.getElementById('packed-loader').style.display = 'none';
            if(!items) return;

            items.forEach(i => {
                const html = `<div class="packed-card"><div class="packed-bill">Bill #${i.bill_number}</div><div style="color:white">${i.designs?.name} (${i.size})</div><div style="color:#666">${i.id}</div>${i.current_location === 'SHOP_PACKED' ? `<button class="btn-send" onclick="sendToGodown('${i.id}')">SEND ‚ûî GODOWN</button>` : ''}${i.current_location === 'TRANSIT_TO_PACKING' ? '<div style="color:#2196F3;font-size:9px">Transiting...</div>' : ''}</div>`;
                if(i.current_location === 'SHOP_PACKED') sList.innerHTML += html; else gList.innerHTML += html;
            });
        }
        async function sendToGodown(id) { if(confirm("Send to Godown?")) { await supabase.from('items').update({ current_location: 'TRANSIT_TO_PACKING' }).eq('id', id); loadPackedOrders(); } }

        // --- MASTER JI ---
        async function loadMasterStatus() {
            document.getElementById('master-loader').style.display = 'block';
            const { data: items } = await supabase.from('items').select('*, designs(name)').in('current_location', ['MASTER_PENDING', 'MASTER_WORKING', 'MASTER_COMPLETED']).order('bill_number', {ascending:true});
            const pList = document.getElementById('master-pending-list');
            const dList = document.getElementById('master-done-list');
            pList.innerHTML = ''; dList.innerHTML = '';
            document.getElementById('master-loader').style.display = 'none';
            if(!items) return;

            items.forEach(i => {
                const isDone = i.current_location === 'MASTER_COMPLETED';
                const statusTxt = i.current_location.replace('MASTER_', '');
                const html = `<div class="packed-card" style="border-left:3px solid ${isDone ? 'var(--done)' : 'orange'}"><div class="packed-bill">Bill #${i.bill_number}</div><div style="color:white">${i.designs?.name}</div><div style="font-size:10px;color:#888">${statusTxt}</div></div>`;
                if(isDone) dList.innerHTML += html; else pList.innerHTML += html;
            });
        }

        function stopScanner() { if(html5QrCode) html5QrCode.stop().catch(()=>{}); document.getElementById('scanner-modal').style.display='none'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
    </script>
</body>
</html>
